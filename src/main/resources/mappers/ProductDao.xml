<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whayer.wx.product.dao.ProductDao">

	<!-- 一对一关系 -->
	<sql id="productFields">
		id,
		name,
		img_url,
		price,
		description,
		create_time
	</sql>
	
	<sql id="product2RoleFields">
		id,
		product_id,
		user_code
	</sql>
	
	<resultMap id="productListMap" type="Product">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="imgUrl" property="img_url" />
        <result column="price" property="price" />
        <result column="description" property="description" />
    </resultMap>
	
	<select id="getProductList"  resultMap="productListMap" >
        select 
        <include refid="productFields" /> 
        from sk_product
    </select>
    
    <insert id="saveProduct" parameterType="Product">
		<![CDATA[
			insert into sk_product(
				id,
				name,
				img_url,
				price,
				description,
				create_time
				)
				values(
				#{id},
				#{name},
				#{imgUrl},
				#{price},
				#{description},
				now()
			)
		]]>
	</insert>
	
	<select id="getProductById" parameterType="String" resultType="Product">
		select
		<include refid="productFields" />
		from sk_product
		where id=#{id}
	</select>
	
	<delete id="deleteProductById" parameterType="String">
		<![CDATA[
			DELETE FROM sk_product WHERE id=#{id}
		]]>
	</delete>
	
	<select id="getProductListByUserType" resultType="Product">
		<!-- 
			code:  1:个人代理编码 2:区域代理编码 xxx:集团用户编码
		 -->
		select
		<include refid="productFields" /> 
		from sk_product t
		where t.id in 
		(
		  select u.product_id from sk_product_role u where u.user_code=#{code}
		)
	</select>
	
	<!-- 产品打标关联 -->
	<insert id="associate">
		insert into sk_product_role 
		(
			<include refid="product2RoleFields" /> 
		)
        values
        <foreach collection="ids" item="item" index="index" separator=",">
            (
            	REPLACE(UUID(), '-', ''), 
            	#{item},
            	#{role} <!--可以使用param1 param2 -->
            )
        </foreach>
	</insert>
</mapper>