<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whayer.wx.coupon.dao.CouponDao">
	<!-- 一对一关系 -->
	<sql id="couponFields">
		id,
		user_id,
		create_user_id,
		amount,
		is_effect,
		is_expired,
		create_date,
		use_date
	</sql>
	
	<resultMap id="couponListMap" type="Coupon">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="create_user_id" property="createUserId" />
        <result column="amount" property="amount" />
        <result column="is_effect" property="isEffect" />
        <result column="is_expired" property="isExpired" />
        <result column="create_date" property="createDate" />
        <result column="use_date" property="useDate" />
    </resultMap>

	<select id="getCouponListByUid" parameterType="String" resultMap="couponListMap" >
		<![CDATA[
	        select 
	        id,
			user_id,
			create_user_id,
			amount,
			is_effect,
			is_expired,
			create_date,
			use_date 
	        from sk_coupon 
	        where user_id = #{userId} 
        ]]>
    </select>
    
    <select id="getCouponById"  parameterType="String" resultType="Coupon">
   		select
		<include refid="couponFields" />
		from sk_coupon
		where id=#{id}
    </select>
    
    <insert id="saveCoupon" parameterType="Coupon">
    	<![CDATA[
    		INSERT INTO sk_coupon(
				id,
				user_id,
				create_user_id,
				amount,
				is_effect,
				is_expired,
				create_date
				)
			VALUES(
				#{id},
				#{userId},
				#{createUserId},
				#{amount},
				1,
				0,
				now()
			)
    	]]>
    </insert>
    
    <delete id="deleteCouponById" parameterType="String">
   		<![CDATA[
   			DELETE FROM sk_coupon WHERE id=#{id}
   		]]>
    </delete>
    
    <select id="validate" resultType="Coupon">
    	SELECT 
		<include refid="couponFields" />
    	FROM sk_coupon 
    	WHERE 1=1
    	<if test="userId != null and userId != ''"> 
    		AND user_id = #{userId}
    	</if> 
    	<if test="code != null and code != ''"> 
    		AND id = #{code}
    	</if> 
    </select>
    
    <!-- 验证有效性与用户 -->
    <select id="validate_old" resultType="Coupon">
    	SELECT 
    	<include refid="couponFields" />
    	FROM sk_coupon t
    	<trim prefix="WHERE" prefixOverrides="AND|OR">
    		<if test="code != null and code != ''"> t.id=#{code} </if>
	　　　　  <if test="userId != null and userId != ''"> AND t.user_id=#{userId} </if>
			<if test="1==1"> AND t.is_effect = 1 </if>
			<if test="1==1"> AND t.is_expired = 0 </if>
		</trim>
    </select>
    
    <update id="updateStateByIds">
    	 UPDATE sk_coupon SET is_effect = 0, use_date = NOW() WHERE id IN
	    <foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
	        #{item}
	    </foreach>
    </update>
</mapper>
